<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Graph Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Rule-Based Graph Generator</h1>
            <p>Generate interactive financial charts with validation</p>
        </header>

        <div class="main-content">
            <div class="controls-section">
                <h2>Graph Configuration</h2>
                
                <div class="form-group">
                    <label for="title">Graph Title *</label>
                    <input type="text" id="title" placeholder="e.g., Monthly Revenue Analysis">
                </div>

                <div class="form-group">
                    <label for="graphType">Graph Type *</label>
                    <select id="graphType">
                        <option value="">Select type...</option>
                    </select>
                    <small id="graphDescription"></small>
                </div>

                <div class="form-group">
                    <label for="xAxis">X-Axis Column *</label>
                    <select id="xAxis">
                        <option value="">Select column...</option>
                    </select>
                    <small id="xAxisInfo"></small>
                </div>

                <div class="form-group">
                    <label for="yAxis">Y-Axis Column *</label>
                    <select id="yAxis">
                        <option value="">Select column...</option>
                    </select>
                    <small id="yAxisInfo"></small>
                </div>

                <div class="form-group">
                    <label for="groupBy">Group By (Optional)</label>
                    <select id="groupBy">
                        <option value="">None</option>
                    </select>
                </div>

                <button id="generateBtn" class="btn-primary">
                    ðŸš€ Generate Graph
                </button>

                <div id="messages"></div>
            </div>

            <div class="output-section">
                <div class="tabs">
                    <button class="tab active" data-tab="graph">ðŸ“ˆ Graph</button>
                    <button class="tab" data-tab="data">ðŸ“‹ Data Preview</button>
                </div>

                <div id="graphTab" class="tab-content active">
                    <div id="graphOutput" class="empty-state">
                        <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17l-5-5-3 3-5-5"></path>
                        </svg>
                        <p>Configure and generate your first graph</p>
                    </div>
                </div>

                <div id="dataTab" class="tab-content">
                    <div id="dataPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let columns = [];
        let graphTypes = [];

        // Load initial data
        async function init() {
            await loadColumns();
            await loadGraphTypes();
            await loadDataPreview();
        }

        // Load columns
        async function loadColumns() {
            const response = await fetch('/api/columns');
            const data = await response.json();
            columns = data.columns;
            
            const xAxis = document.getElementById('xAxis');
            const yAxis = document.getElementById('yAxis');
            const groupBy = document.getElementById('groupBy');
            
            columns.forEach(col => {
                const option = `<option value="${col.name}">${col.name} (${col.unique_values} unique)</option>`;
                xAxis.innerHTML += option;
                yAxis.innerHTML += option;
                groupBy.innerHTML += option;
            });
        }

        // Load graph types
        async function loadGraphTypes() {
            const response = await fetch('/api/graph-types');
            const data = await response.json();
            graphTypes = data.graph_types;
            
            const graphType = document.getElementById('graphType');
            graphTypes.forEach(type => {
                graphType.innerHTML += `<option value="${type.value}">${type.label}</option>`;
            });
        }

        // Load data preview
        async function loadDataPreview() {
            const response = await fetch('/api/data-preview');
            const data = await response.json();
            
            const preview = document.getElementById('dataPreview');
            
            let html = `<p><strong>Total Rows:</strong> ${data.total_rows}</p>`;
            html += '<div class="table-container"><table><thead><tr>';
            
            data.columns.forEach(col => {
                html += `<th>${col}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            data.preview.forEach(row => {
                html += '<tr>';
                data.columns.forEach(col => {
                    const value = row[col] !== null ? row[col] : 'N/A';
                    const displayValue = typeof value === 'number' ? value.toFixed(2) : value;
                    html += `<td>${displayValue}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            preview.innerHTML = html;
        }

        // Update graph description
        document.getElementById('graphType').addEventListener('change', (e) => {
            const type = graphTypes.find(t => t.value === e.target.value);
            document.getElementById('graphDescription').textContent = type ? type.description : '';
        });

        // Update column info
        function updateColumnInfo(selectId, infoId) {
            document.getElementById(selectId).addEventListener('change', (e) => {
                const col = columns.find(c => c.name === e.target.value);
                const info = document.getElementById(infoId);
                if (col) {
                    info.textContent = `Type: ${col.type}, Unique values: ${col.unique_values}`;
                } else {
                    info.textContent = '';
                }
            });
        }
        updateColumnInfo('xAxis', 'xAxisInfo');
        updateColumnInfo('yAxis', 'yAxisInfo');

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Generate graph
        document.getElementById('generateBtn').addEventListener('click', async () => {
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            const title = document.getElementById('title').value;
            const graphType = document.getElementById('graphType').value;
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const groupBy = document.getElementById('groupBy').value;
            
            if (!title || !graphType || !xAxis || !yAxis) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            showMessage('Generating graph...', 'info');
            
            try {
                const response = await fetch('/api/generate-graph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        graph_type: graphType,
                        x_axis: xAxis,
                        y_axis: yAxis,
                        group_by: groupBy || null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('graphOutput').innerHTML = result.html;
                    
                    // Switch to graph tab
                    document.querySelector('[data-tab="graph"]').click();
                    
                    showMessage('Graph generated successfully!', 'success');
                    
                    if (result.warnings && result.warnings.length > 0) {
                        result.warnings.forEach(warning => {
                            showMessage(warning, 'warning');
                        });
                    }
                } else {
                    showMessage('Failed to generate graph', 'error');
                    result.errors.forEach(error => {
                        showMessage(error, 'error');
                    });
                }
                
            } catch (error) {
                showMessage('Network error: ' + error.message, 'error');
            }
        });

        // Show message
        function showMessage(text, type) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messages.appendChild(div);
            
            if (type === 'info') {
                setTimeout(() => div.remove(), 3000);
            }
        }

        // Initialize on load
        init();
    </script>
</body>
</html>