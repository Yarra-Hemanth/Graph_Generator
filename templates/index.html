<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Graph Generator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Plotly CDN -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Rule-Based Graph Generator</h1>
            <p>Generate interactive financial charts with validation</p>
        </header>

        <div class="main-content">
            <div class="controls-section">
                <h2>Graph Configuration</h2>
                
                <div class="form-group">
                    <label for="title">Graph Title *</label>
                    <input type="text" id="title" placeholder="e.g., Monthly Revenue Analysis">
                </div>

                <div class="form-group">
                    <label for="graphType">Graph Type *</label>
                    <select id="graphType">
                        <option value="">Select type...</option>
                    </select>
                    <small id="graphDescription"></small>
                </div>

                <div class="form-group">
                    <label for="xAxis">X-Axis Column *</label>
                    <select id="xAxis">
                        <option value="">Select column...</option>
                    </select>
                    <small id="xAxisInfo"></small>
                </div>

                <div class="form-group">
                    <label for="yAxis">Y-Axis Column *</label>
                    <select id="yAxis">
                        <option value="">Select column...</option>
                    </select>
                    <small id="yAxisInfo"></small>
                </div>

                <div class="form-group">
                    <label for="groupBy">Group By (Optional)</label>
                    <select id="groupBy">
                        <option value="">None</option>
                    </select>
                </div>

                <button id="generateBtn" class="btn-primary">
                    ðŸš€ Generate Graph
                </button>

                <div id="messages"></div>
            </div>

            <div class="output-section">
                <div class="tabs">
                    <button class="tab active" data-tab="graph">ðŸ“ˆ Graph</button>
                    <button class="tab" data-tab="data">ðŸ“‹ Data Preview</button>
                </div>

                <div id="graphTab" class="tab-content active">
                    <div id="graphOutput" class="empty-state">
                        <svg width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17l-5-5-3 3-5-5"></path>
                        </svg>
                        <p>Configure and generate your first graph</p>
                    </div>
                </div>

                <div id="dataTab" class="tab-content">
                    <div id="dataPreview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let columns = [];
        let graphTypes = [];

        // Helper function to execute scripts in injected HTML
        function executeScripts(containerElement) {
            const scripts = containerElement.querySelectorAll('script');
            scripts.forEach((oldScript) => {
                const newScript = document.createElement('script');
                Array.from(oldScript.attributes).forEach(attr => {
                    newScript.setAttribute(attr.name, attr.value);
                });
                newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                oldScript.parentNode.replaceChild(newScript, oldScript);
            });
        }

        // Load initial data
        async function init() {
            console.log('Initializing application...');
            await loadColumns();
            await loadGraphTypes();
            await loadDataPreview();
            console.log('Application initialized successfully!');
        }

        // Load columns
        async function loadColumns() {
            try {
                console.log('Loading columns...');
                const response = await fetch('/api/columns');
                const data = await response.json();
                columns = data.columns;
                console.log('Columns loaded:', columns.length);
                
                const xAxis = document.getElementById('xAxis');
                const yAxis = document.getElementById('yAxis');
                const groupBy = document.getElementById('groupBy');
                
                columns.forEach(col => {
                    const option = `<option value="${col.name}">${col.name} (${col.unique_values} unique)</option>`;
                    xAxis.innerHTML += option;
                    yAxis.innerHTML += option;
                    groupBy.innerHTML += option;
                });
            } catch (error) {
                console.error('Error loading columns:', error);
                showMessage('Failed to load columns: ' + error.message, 'error');
            }
        }

        // Load graph types
        async function loadGraphTypes() {
            try {
                console.log('Loading graph types...');
                const response = await fetch('/api/graph-types');
                const data = await response.json();
                graphTypes = data.graph_types;
                console.log('Graph types loaded:', graphTypes.length);
                
                const graphType = document.getElementById('graphType');
                graphTypes.forEach(type => {
                    graphType.innerHTML += `<option value="${type.value}">${type.label}</option>`;
                });
            } catch (error) {
                console.error('Error loading graph types:', error);
                showMessage('Failed to load graph types: ' + error.message, 'error');
            }
        }

        // Load data preview
        async function loadDataPreview() {
            try {
                console.log('Loading data preview...');
                const response = await fetch('/api/data-preview');
                const data = await response.json();
                console.log('Data preview loaded:', data.total_rows, 'rows');
                
                const preview = document.getElementById('dataPreview');
                
                let html = `<p style="padding: 10px;"><strong>Total Rows:</strong> ${data.total_rows}</p>`;
                html += '<div class="table-container"><table><thead><tr>';
                
                data.columns.forEach(col => {
                    html += `<th>${col}</th>`;
                });
                html += '</tr></thead><tbody>';
                
                data.preview.forEach(row => {
                    html += '<tr>';
                    data.columns.forEach(col => {
                        const value = row[col] !== null ? row[col] : 'N/A';
                        const displayValue = typeof value === 'number' ? value.toFixed(2) : value;
                        html += `<td>${displayValue}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                preview.innerHTML = html;
            } catch (error) {
                console.error('Error loading data preview:', error);
                showMessage('Failed to load data preview: ' + error.message, 'error');
            }
        }

        // Update graph description
        document.getElementById('graphType').addEventListener('change', (e) => {
            const type = graphTypes.find(t => t.value === e.target.value);
            document.getElementById('graphDescription').textContent = type ? type.description : '';
        });

        // Update column info
        function updateColumnInfo(selectId, infoId) {
            document.getElementById(selectId).addEventListener('change', (e) => {
                const col = columns.find(c => c.name === e.target.value);
                const info = document.getElementById(infoId);
                if (col) {
                    info.textContent = `Type: ${col.type}, Unique values: ${col.unique_values}`;
                } else {
                    info.textContent = '';
                }
            });
        }
        updateColumnInfo('xAxis', 'xAxisInfo');
        updateColumnInfo('yAxis', 'yAxisInfo');

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById(tabName + 'Tab').classList.add('active');
            });
        });

        // Generate graph - FIXED VERSION
        document.getElementById('generateBtn').addEventListener('click', async () => {
            console.log('=== Generate Button Clicked ===');
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            const title = document.getElementById('title').value;
            const graphType = document.getElementById('graphType').value;
            const xAxis = document.getElementById('xAxis').value;
            const yAxis = document.getElementById('yAxis').value;
            const groupBy = document.getElementById('groupBy').value;
            
            console.log('Form values:', { title, graphType, xAxis, yAxis, groupBy });
            
            if (!title || !graphType || !xAxis || !yAxis) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            showMessage('Generating graph...', 'info');
            
            try {
                console.log('Sending POST request to /api/generate-graph...');
                const response = await fetch('/api/generate-graph', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        title,
                        graph_type: graphType,
                        x_axis: xAxis,
                        y_axis: yAxis,
                        group_by: groupBy || null
                    })
                });
                
                console.log('Response status:', response.status);
                const result = await response.json();
                console.log('Response success:', result.success);
                
                if (result.success) {
                    console.log('HTML received, length:', result.html ? result.html.length : 0);
                    
                    // METHOD 1: Direct innerHTML injection with script execution
                    const graphOutput = document.getElementById('graphOutput');
                    
                    // Clear the container first
                    graphOutput.innerHTML = '';
                    
                    // Create a temporary container
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = result.html;
                    
                    // Move all content to the actual container
                    while (tempDiv.firstChild) {
                        graphOutput.appendChild(tempDiv.firstChild);
                    }
                    
                    // Execute any scripts that were in the HTML
                    executeScripts(graphOutput);
                    
                    console.log('âœ… Graph HTML injected and scripts executed');
                    
                    // Switch to graph tab
                    document.querySelector('[data-tab="graph"]').click();
                    
                    // Clear messages and show success
                    messages.innerHTML = '';
                    showMessage('âœ… Graph generated successfully!', 'success');
                    
                    if (result.warnings && result.warnings.length > 0) {
                        result.warnings.forEach(warning => {
                            showMessage('âš ï¸ ' + warning, 'warning');
                        });
                    }
                    
                    // Extra debug: Check if Plotly div exists
                    setTimeout(() => {
                        const plotlyDiv = graphOutput.querySelector('.plotly-graph-div');
                        if (plotlyDiv) {
                            console.log('âœ… Plotly div found:', plotlyDiv.id);
                        } else {
                            console.warn('âš ï¸ No Plotly div found in output');
                            console.log('Output innerHTML:', graphOutput.innerHTML.substring(0, 500));
                        }
                    }, 100);
                    
                } else {
                    console.error('Generation failed:', result);
                    messages.innerHTML = '';
                    showMessage('âŒ Failed to generate graph', 'error');
                    if (result.errors) {
                        result.errors.forEach(error => {
                            showMessage('âŒ ' + error, 'error');
                        });
                    }
                }
                
            } catch (error) {
                console.error('Network/Parse error:', error);
                messages.innerHTML = '';
                showMessage('âŒ Error: ' + error.message, 'error');
            }
        });

        // Show message
        function showMessage(text, type) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = text;
            messages.appendChild(div);
            
            if (type === 'info') {
                setTimeout(() => div.remove(), 3000);
            }
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');
            console.log('Plotly available?', typeof Plotly !== 'undefined');
            init();
        });
    </script>
</body>
</html>